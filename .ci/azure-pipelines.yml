trigger:
  batch: true
  branches:
    include:
      - "*"
  tags:
    include:
      - "*"
pr:
  branches:
    include:
      - "*"

jobs:
  - job: Build
    displayName: "Build"

    pool:
      vmImage: "ubuntu-latest"

    steps:
      - task: NodeTool@0
        displayName: "Install Node"
        inputs:
          versionSpec: "12.x"

      - task: Cache@2
        displayName: "Check Cache"
        inputs:
          key: "yarn | yarn.lock"
          path: "node_modules"
          cacheHitVar: CACHE_RESTORED

      - script: "apt-get install -y rpmbuild"
        displayName: "Install Apt Dependencies"

      - script: "yarn install --frozen-lockfile --non-interactive"
        displayName: "Install Node Dependencies"

      - script: "yarn build:linux"
        displayName: "Build Linux Packages"

      - script: "mkdir jellyfin-desktop"
        displayName: "Make Output Directory"

      - script: "mv dist/*.{AppImage,tar.xz,snap,deb,rpm} jellyfin-desktop"
        displayName: "Move Binaries to Output"

      - task: PublishPipelineArtifact@1
        displayName: "Publish Artifacts"
        inputs:
          targetPath: "jellyfin-desktop"
          artifactName: "jellyfin-desktop"

  - job: Lint
    displayName: "Lint"

    pool:
      vmImage: "ubuntu-latest"

    steps:
      - task: NodeTool@0
        displayName: "Install Node"
        inputs:
          versionSpec: "12.x"

      - task: Cache@2
        displayName: "Check Cache"
        inputs:
          key: "yarn | yarn.lock"
          path: "node_modules"
          cacheHitVar: CACHE_RESTORED

      - script: "yarn install --frozen-lockfile --non-interactive"
        displayName: "Install Dependencies"

      - script: "yarn lint"
        displayName: "Run ESLint"
